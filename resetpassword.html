<!DOCTYPE html>
<html>
<head>
  <title>Reset Password</title>
  <script src="https://www.gstatic.com/firebasejs/4.9.1/firebase.js"></script>
  <script src='https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js'></script>
  <link rel="stylesheet" type="text/css" href="resetpassword.css">
  <script>
    // Initialize Firebase
    var config = {
      apiKey: "AIzaSyAK7odv2vBxJdDMThZHkBjoNdsypVNDGDU",
      authDomain: "spotmebro-82458.firebaseapp.com",
      databaseURL: "https://spotmebro-82458.firebaseio.com",
      projectId: "spotmebro-82458",
      storageBucket: "spotmebro-82458.appspot.com",
      messagingSenderId: "737240148087"
    };
    firebase.initializeApp(config);
  </script>
</head>
<body>
  <div class="container">
    <h1>Reset Password</h1>
    <div id="emailInput">
      Email: </br>
      <input id="submitEmail" type="text" placeholder="Email"><br>
    </div>
    <button id="btnSubmitEmail" onclick="matchEmail()">Submit Email</button>
    <div id="securityQA">
      <h5 id="securityQuestion">Security Question: </h5><br>
      Answer: </br>
      <input id="submitSecurityAnswer" type="text" placeholder="Answer"></br>
    </div>
    <button id="backBtn" onclick="location.href='signin.html'">Back</button>
    <button id="btnResetPasswordSubmit" onclick="answerSecurity()">Submit</button>
  </div>
  <script type="text/javascript">
    var email_val;
    var securityQuestion_val;
    var securityAnswer_val;

    var emailInput;

    //References to the values in User on firebase
    function matchEmail(){
      var ref = firebase.database().ref('Users');
      ref.on('value', emailData, errData);
    }

    //Function to retrieve all email and match with user's inputted email
    function emailData(data){
      //Retrieves user's email input
      emailInput = document.getElementById("submitEmail").value;
      //Retrieves all data from the database
      var allData = data.val();
      //Keys stores all of the UID from the database
      var keys = Object.keys(allData);
      //For loop goes through every data and retrieves the email value of all users
      for(var i = 0; i < keys.length; i++){
        var k = keys[i];
        //Passes the email to variable email_val
        var email_val = allData[k].Email;
        if(emailInput.toLowerCase() == email_val.toLowerCase()){
          //Passes the security auestion of that particular email to securityQuestion_val
          securityQuestion_val = allData[k].Security;
          //Passes the security answer of that particular email to securityAnswer_val
          securityAnswer_val = allData[k].Answer;
          document.getElementById("securityQuestion").innerHTML = " ";
          //Displays the security question of the associated email if the inputted email is correct
          document.getElementById("securityQuestion").innerHTML += securityQuestion_val;
        }
        else if(emailInput.toLowerCase() != email_val.toLowerCase()){
          //alert("This email does not exist")
        }
      }
    }

    function errData(error){

    }

    //Match user's inputted security answer to the security answer stored in firebase
    function answerSecurity(){
      var answerInput = document.getElementById("submitSecurityAnswer").value;
      if(answerInput == securityAnswer_val){

      }
      else {

      }
    }

    /*function matchEmail(){
      var queryEmail = firebase.database().ref();
      ref.on("value", function(snapshot){
        alert(snapshot.val());
      }, function (error) {
        console.log("Error: ", error.code);
      });
    }
      /*
      queryEmail.once("value").then(function(snapshot)){
        snapshot.forEach(function(childSnapshot)){
          var key = childSnapshot.key;
          var childData = childSnapshot.val();

          email_val = childSnapshot.val().Email;
          securityQuestion_val = childSnapshot.val().Security;
          securityAnswer_val = childSnapshot.val().Answer;
        }
      }

      if(emailInput == email_val){
        document.getElementById("securityQuestion").innerHTML += securityQuestion_val;
      }
      else{
        alert("This email does not exist!");
      }
    }

    btnResetPasswordSubmit.addEventListener('click', e => {
      if(answerInput == securityAnswer_val){
        firebase.auth().sendPasswordResetEmail('email_val', actionCodeSettings).then(function() {
          alert("Password reset email sent!");
        })
        catch(function(error){
          alert("An error has occurred!");
        });
      }
      else{
        alert("Incorrect security question answer!");
      }
    })*/
  </script>
</body>
</html>
